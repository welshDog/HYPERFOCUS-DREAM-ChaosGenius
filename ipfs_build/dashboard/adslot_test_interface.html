<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Broski Ultra Adslot System - ULTRA MODE</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .ultra-badge {
            background: linear-gradient(45deg, #FF6EF7, #FF8E53);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tab:last-child { border-right: none; }
        .tab.active {
            background: linear-gradient(45deg, #FF6EF7, #FF8E53);
            transform: scale(1.02);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        input, select, textarea {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        button {
            background: linear-gradient(45deg, #FF6EF7, #FF8E53);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        .price-display {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
            font-size: 1.2em;
            font-weight: bold;
        }
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 15px 0;
        }
        .upload-area:hover {
            border-color: #FF6EF7;
            background: rgba(255, 110, 247, 0.1);
        }
        .upload-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
        }
        #results {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 100px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin: 5px;
        }
        .status.success { background: #4CAF50; }
        .status.error { background: #f44336; }
        .status.info { background: #2196F3; }
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .analytics-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .analytics-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #FF6EF7;
            margin: 10px 0;
        }
        .chart-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #333;
            min-height: 300px;
        }
        .file-input {
            display: none;
        }
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .slot-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }
        .slot-card.available {
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }
        .slot-card.occupied {
            border-color: #FF6EF7;
            box-shadow: 0 0 20px rgba(255, 110, 247, 0.3);
        }
        .dynamic-price {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>üéØ Broski Ultra Adslot System<span class="ultra-badge">ULTRA MODE</span></h1>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Analytics Dashboard</button>
            <button class="tab" onclick="showTab('slots')">üéØ Ad Slots</button>
            <button class="tab" onclick="showTab('claim')">üí∞ Claim Slot</button>
            <button class="tab" onclick="showTab('upload')">üé® Upload Image</button>
            <button class="tab" onclick="showTab('admin')">üõ†Ô∏è Admin</button>
        </div>

        <!-- Analytics Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="section">
                <h2>üìä Real-Time Analytics Dashboard</h2>
                <button onclick="loadAnalytics()">üîÑ Refresh Analytics</button>

                <div class="analytics-grid" id="analytics-cards">
                    <div class="analytics-card">
                        <h3>üí∞ Total Revenue</h3>
                        <div class="analytics-number" id="total-revenue">0</div>
                        <p>BROski$ Earned</p>
                    </div>
                    <div class="analytics-card">
                        <h3>üéØ Total Claims</h3>
                        <div class="analytics-number" id="total-claims">0</div>
                        <p>Slots Claimed</p>
                    </div>
                    <div class="analytics-card">
                        <h3>üë• Unique Users</h3>
                        <div class="analytics-number" id="unique-users">0</div>
                        <p>Active Users</p>
                    </div>
                    <div class="analytics-card">
                        <h3>üìà Today's Activity</h3>
                        <div class="analytics-number" id="daily-activity">0</div>
                        <p>Events Tracked</p>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìà Revenue Trends (Last 7 Days)</h3>
                    <canvas id="revenueChart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üéØ Popular Slots</h3>
                    <canvas id="slotsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Ad Slots Tab -->
        <div id="slots" class="tab-content">
            <div class="section">
                <h2>üéØ Active Ad Slots with Dynamic Pricing</h2>
                <button onclick="loadSlotsWithPricing()">üîÑ Refresh Slots & Pricing</button>
                <div class="slots-grid" id="slots-display"></div>
            </div>
        </div>

        <!-- Claim Slot Tab -->
        <div id="claim" class="tab-content">
            <div class="section">
                <h2>üéØ Claim Ad Slot with Dynamic Pricing</h2>

                <div class="form-group">
                    <label>Slot Number (1-5):</label>
                    <select id="slot" onchange="updatePrice()">
                        <option value="1">Slot 1</option>
                        <option value="2">Slot 2</option>
                        <option value="3">Slot 3</option>
                        <option value="4">Slot 4</option>
                        <option value="5">Slot 5</option>
                    </select>
                </div>

                <div class="price-display" id="current-price">
                    üí∞ Loading current price...
                </div>

                <div class="form-group">
                    <label>Ad Title:</label>
                    <input type="text" id="title" placeholder="Your amazing ad title">
                </div>
                <div class="form-group">
                    <label>Website URL:</label>
                    <input type="url" id="url" placeholder="https://yoursite.com">
                </div>
                <div class="form-group">
                    <label>Image URL (or upload below):</label>
                    <input type="url" id="image" placeholder="https://yourimage.com/banner.jpg">
                </div>
                <div class="form-group">
                    <label>User ID (Test User):</label>
                    <select id="userId">
                        <option value="123456789">TestUser1 (1000 BROski$)</option>
                        <option value="987654321">TestUser2 (500 BROski$)</option>
                    </select>
                </div>
                <button onclick="claimSlot()">üí∞ Claim Slot (Dynamic Price)</button>
            </div>
        </div>

        <!-- Upload Image Tab -->
        <div id="upload" class="tab-content">
            <div class="section">
                <h2>üé® Upload Ad Image</h2>

                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div id="upload-content">
                        <h3>üì∏ Click to Upload Image</h3>
                        <p>Supported formats: PNG, JPG, JPEG, GIF, WEBP</p>
                        <p>Maximum size: 5MB</p>
                    </div>
                    <img id="preview" class="upload-preview" style="display: none;">
                </div>

                <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="previewImage(this)">

                <div class="form-group">
                    <label>User ID for Upload:</label>
                    <select id="uploadUserId">
                        <option value="123456789">TestUser1</option>
                        <option value="987654321">TestUser2</option>
                    </select>
                </div>

                <button onclick="uploadImage()" id="uploadBtn" disabled>üöÄ Upload Image</button>

                <div id="upload-result" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="admin" class="tab-content">
            <div class="section">
                <h2>üõ†Ô∏è Admin Controls</h2>
                <div class="form-group">
                    <label>Delete Slot:</label>
                    <select id="deleteSlot">
                        <option value="1">Slot 1</option>
                        <option value="2">Slot 2</option>
                        <option value="3">Slot 3</option>
                        <option value="4">Slot 4</option>
                        <option value="5">Slot 5</option>
                    </select>
                </div>
                <button onclick="deleteSlot()" style="background: linear-gradient(45deg, #ff4444, #cc0000);">üóëÔ∏è Delete Slot</button>

                <div style="margin-top: 30px;">
                    <h3>üìä Analytics Export</h3>
                    <button onclick="exportAnalytics()">üì• Export Analytics Data</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìä System Logs</h2>
            <div id="results">üî• BROSKI ULTRA ADSLOT SYSTEM - ULTRA MODE ACTIVATED! üî•
Ready to test all advanced features! üöÄ</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001/api';
        let currentSlotPrices = {};

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'dashboard') {
                loadAnalytics();
            } else if (tabName === 'slots') {
                loadSlotsWithPricing();
            } else if (tabName === 'claim') {
                updatePrice();
            }
        }

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `[${timestamp}] <span class="status ${statusClass}">${type.toUpperCase()}</span> ${message}\n`;
            results.scrollTop = results.scrollHeight;
        }

        async function loadAnalytics() {
            try {
                log('Loading analytics dashboard...', 'info');
                const response = await fetch(`${API_BASE}/analytics/dashboard`);
                const data = await response.json();

                // Update analytics cards
                document.getElementById('total-revenue').textContent = data.total_revenue || 0;
                document.getElementById('total-claims').textContent = data.total_claims || 0;
                document.getElementById('unique-users').textContent = data.unique_users || 0;

                // Calculate daily activity
                const dailyActivity = Object.values(data.recent_activity || {}).reduce((a, b) => a + b, 0);
                document.getElementById('daily-activity').textContent = dailyActivity;

                // Create revenue chart
                createRevenueChart(data.revenue_by_day || []);

                // Create slots popularity chart
                createSlotsChart(data.popular_slots || []);

                log('Analytics dashboard loaded successfully!', 'success');
            } catch (error) {
                log(`Error loading analytics: ${error.message}`, 'error');
            }
        }

        function createRevenueChart(revenueData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: revenueData.map(d => d.date),
                    datasets: [{
                        label: 'Revenue (BROski$)',
                        data: revenueData.map(d => d.revenue),
                        borderColor: '#FF6EF7',
                        backgroundColor: 'rgba(255, 110, 247, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#333' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#333' }
                        },
                        x: {
                            ticks: { color: '#333' }
                        }
                    }
                }
            });
        }

        function createSlotsChart(slotsData) {
            const ctx = document.getElementById('slotsChart').getContext('2d');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: slotsData.map(s => `Slot ${s.slot}`),
                    datasets: [{
                        data: slotsData.map(s => s.views),
                        backgroundColor: [
                            '#FF6EF7', '#FF8E53', '#4CAF50', '#2196F3', '#FFC107'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#333' }
                        }
                    }
                }
            });
        }

        async function loadSlotsWithPricing() {
            try {
                log('Loading slots with dynamic pricing...', 'info');

                // Load current slots
                const slotsResponse = await fetch(`${API_BASE}/adslots`);
                const slots = await slotsResponse.json();

                // Load pricing for each slot
                const pricingPromises = [];
                for (let i = 1; i <= 5; i++) {
                    pricingPromises.push(fetch(`${API_BASE}/adslots/${i}/price`).then(r => r.json()));
                }
                const pricing = await Promise.all(pricingPromises);

                const slotsDisplay = document.getElementById('slots-display');
                let html = '';

                for (let i = 1; i <= 5; i++) {
                    const slot = slots.find(s => s.slot === i);
                    const price = pricing[i-1];

                    if (slot) {
                        // Occupied slot
                        const expires = new Date(slot.expires * 1000);
                        html += `
                            <div class="slot-card occupied">
                                <div class="dynamic-price">üí∞ ${price.price} BROski$</div>
                                <h3>üéØ Slot #${i} - OCCUPIED</h3>
                                <h4>${slot.title}</h4>
                                <p>üë§ Owner: ${slot.user_name}</p>
                                <p>‚è∞ Expires: ${expires.toLocaleDateString()}</p>
                                <p>üîó <a href="${slot.url}" target="_blank" style="color: #FF6EF7;">${slot.url}</a></p>
                                <img src="${slot.image}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;" onerror="this.style.display='none'">
                                <button onclick="trackClick(${i})" style="margin-top: 10px;">üëÜ Track Click</button>
                            </div>
                        `;
                    } else {
                        // Available slot
                        html += `
                            <div class="slot-card available">
                                <div class="dynamic-price">üí∞ ${price.price} BROski$</div>
                                <h3>üéØ Slot #${i} - AVAILABLE</h3>
                                <p>‚úÖ Ready for your ad!</p>
                                <p>üí° Current Price: <strong>${price.price} BROski$</strong></p>
                                <p>üìä Base Price: ${price.base_price} BROski$</p>
                                <button onclick="selectSlotToClaim(${i})">üöÄ Claim This Slot</button>
                            </div>
                        `;
                    }
                }

                slotsDisplay.innerHTML = html;
                log('Slots and pricing loaded successfully!', 'success');

            } catch (error) {
                log(`Error loading slots: ${error.message}`, 'error');
            }
        }

        function selectSlotToClaim(slotNumber) {
            // Switch to claim tab and select the slot
            showTab('claim');
            document.getElementById('slot').value = slotNumber;
            updatePrice();
        }

        async function updatePrice() {
            const slot = document.getElementById('slot').value;
            try {
                const response = await fetch(`${API_BASE}/adslots/${slot}/price`);
                const data = await response.json();

                document.getElementById('current-price').innerHTML = `
                    üí∞ Current Price: <strong>${data.price} BROski$</strong><br>
                    üìä Base Price: ${data.base_price} BROski$ | üìà Dynamic Pricing Active
                `;

                currentSlotPrices[slot] = data.price;

            } catch (error) {
                document.getElementById('current-price').innerHTML = '‚ùå Error loading price';
                log(`Error loading price: ${error.message}`, 'error');
            }
        }

        function previewImage(input) {
            const file = input.files[0];
            const preview = document.getElementById('preview');
            const uploadContent = document.getElementById('upload-content');
            const uploadBtn = document.getElementById('uploadBtn');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    uploadContent.style.display = 'none';
                    uploadBtn.disabled = false;
                };
                reader.readAsDataURL(file);

                log(`Image selected: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
            }
        }

        async function uploadImage() {
            const fileInput = document.getElementById('fileInput');
            const userId = document.getElementById('uploadUserId').value;

            if (!fileInput.files[0]) {
                log('Please select an image first!', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('user_id', userId);

            try {
                log('Uploading image...', 'info');

                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    log(`üéâ Image uploaded successfully! URL: ${result.url}`, 'success');

                    // Update the image URL in claim form if on that tab
                    document.getElementById('image').value = `http://localhost:5001${result.url}`;

                    // Show result
                    document.getElementById('upload-result').innerHTML = `
                        <div style="background: rgba(76, 175, 80, 0.2); padding: 15px; border-radius: 10px; border: 1px solid #4CAF50;">
                            <h4>‚úÖ Upload Successful!</h4>
                            <p><strong>Filename:</strong> ${result.filename}</p>
                            <p><strong>Size:</strong> ${(result.size/1024/1024).toFixed(2)}MB</p>
                            <p><strong>URL:</strong> <code>http://localhost:5001${result.url}</code></p>
                            <img src="http://localhost:5001${result.url}" style="max-width: 200px; border-radius: 8px; margin-top: 10px;">
                        </div>
                    `;

                } else {
                    log(`‚ùå Upload failed: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`Upload error: ${error.message}`, 'error');
            }
        }

        async function claimSlot() {
            try {
                const slot = document.getElementById('slot').value;
                const title = document.getElementById('title').value;
                const url = document.getElementById('url').value;
                const image = document.getElementById('image').value;
                const userId = document.getElementById('userId').value;
                const userName = userId === '123456789' ? 'TestUser1' : 'TestUser2';

                if (!title || !url || !image) {
                    log('Please fill in all fields!', 'error');
                    return;
                }

                const currentPrice = currentSlotPrices[slot] || 100;
                log(`Claiming slot #${slot} for ${userName} at ${currentPrice} BROski$...`, 'info');

                const response = await fetch(`${API_BASE}/adslots/claim`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        slot: parseInt(slot),
                        title,
                        url,
                        image,
                        user: userId,
                        user_name: userName
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    log(`üéâ SUCCESS! Slot #${slot} claimed by ${userName}!`, 'success');
                    log(`üí∞ Final Cost: ${result.cost} BROski$ (Base: ${result.base_cost})`, 'info');
                    log(`üìù Title: ${result.ad.title}`, 'info');

                    // Clear the form
                    document.getElementById('title').value = '';
                    document.getElementById('url').value = '';
                    document.getElementById('image').value = '';

                    // Refresh pricing and slots
                    setTimeout(() => {
                        updatePrice();
                        loadSlotsWithPricing();
                    }, 1000);

                } else {
                    log(`‚ùå ERROR: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
            }
        }

        async function trackClick(slot) {
            try {
                const response = await fetch(`${API_BASE}/adslots/${slot}/click`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 'demo_user' })
                });

                const result = await response.json();
                log(`üëÜ Click tracked for Slot #${slot}`, 'success');

                // Refresh analytics
                if (document.getElementById('dashboard').classList.contains('active')) {
                    setTimeout(loadAnalytics, 500);
                }

            } catch (error) {
                log(`Error tracking click: ${error.message}`, 'error');
            }
        }

        async function deleteSlot() {
            try {
                const slot = document.getElementById('deleteSlot').value;
                log(`Deleting slot #${slot}...`, 'info');

                const response = await fetch(`${API_BASE}/adslots/${slot}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                log(`üóëÔ∏è Slot #${slot} deleted successfully!`, 'success');

                if (result.deleted_ad) {
                    log(`Refund processed for: ${result.deleted_ad.user_name}`, 'info');
                }

                // Refresh displays
                setTimeout(() => {
                    loadSlotsWithPricing();
                    loadAnalytics();
                }, 1000);

            } catch (error) {
                log(`Error deleting slot: ${error.message}`, 'error');
            }
        }

        async function exportAnalytics() {
            try {
                const response = await fetch(`${API_BASE}/analytics/dashboard`);
                const data = await response.json();

                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: 'application/json'
                });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `broski_analytics_${new Date().toISOString().split('T')[0]}.json`;
                a.click();

                log('üì• Analytics data exported successfully!', 'success');

            } catch (error) {
                log(`Export error: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        window.onload = function() {
            loadAnalytics();
            updatePrice();
        };
    </script>
</body>
</html>
